<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medical Stats Dashboard - Dynamic Rankings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;700&display=swap');

    body {
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      background-color: #f1f5f9;
      min-height: 100vh;
    }

    .dataTables_wrapper .dataTables_filter {
      display: none;
    }

    .card {
      background: white;
      border-radius: 0.75rem;
      border: 1px solid #e2e8f0;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .chart-container-small {
      position: relative;
      height: 140px;
      width: 100%;
    }

    .chart-container-full {
      position: relative;
      height: 300px;
      width: 100%;
    }

    table.dataTable thead th {
      background-color: #f8fafc;
      border-bottom: 1px solid #e2e8f0 !important;
      font-size: 0.7rem;
      padding: 8px 10px;
      white-space: nowrap;
      cursor: pointer;
    }

    table.dataTable tbody td {
      padding: 6px 10px;
      font-size: 0.75rem;
    }

    .search-tag {
      cursor: pointer;
      transition: all 0.2s;
    }

    .row-checkbox {
      width: 1rem;
      height: 1rem;
      cursor: pointer;
    }

    /* テーブルの高さを調整して全体を収まりやすくする */
    .dataTables_scrollBody {
      height: calc(100vh - 720px) !important;
      min-height: 250px;
    }
  </style>
</head>

<body class="antialiased text-slate-900">

  <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 px-4 py-2">
    <div class="max-w-[1600px] mx-auto flex items-center justify-between gap-4">
      <div class="flex items-center gap-2">
        <div class="bg-blue-600 p-1.5 rounded-lg">
          <i data-lucide="layout-dashboard" class="text-white w-5 h-5"></i>
        </div>
        <div class="hidden sm:block">
          <h1 class="font-bold text-base leading-none">医療統計分析システム</h1>
          <p class="text-[10px] text-slate-500 mt-0.5">令和6年 社会医療統計 第18表</p>
        </div>
      </div>

      <div class="flex-1 max-w-xl">
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i data-lucide="search" class="text-slate-400 w-4 h-4"></i>
          </div>
          <input type="text" id="globalSearch"
            class="block w-full pl-9 pr-3 py-1.5 border border-slate-300 rounded-lg bg-slate-50 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all"
            placeholder="名称や分類で絞り込み...">
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div id="dataStatus" class="text-[10px] font-bold px-2 py-1 rounded-full bg-yellow-100 text-yellow-700">
          読み込み中...
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-[1600px] mx-auto p-3 space-y-3">

    <!-- Metrics & Summary Row -->
    <div class="grid grid-cols-12 gap-3">
      <div class="col-span-12 lg:col-span-3 flex flex-col gap-2">
        <div class="card p-3 flex-1 flex flex-col justify-center">
          <p class="text-[10px] font-medium text-slate-500 uppercase">選択 / 総点数</p>
          <div class="flex items-baseline gap-2">
            <h3 id="statTotalRows" class="text-lg font-bold mt-0.5">-</h3>
            <span class="text-slate-300">/</span>
            <h3 id="statTotalPoints" class="text-lg font-bold text-blue-600">-</h3>
          </div>
        </div>
        <div class="card p-3 flex-1 flex flex-col justify-center">
          <p class="text-[10px] font-medium text-slate-500 uppercase">入院比率 / 平均単価</p>
          <div class="flex items-baseline gap-2">
            <h3 id="statInpatientRatio" class="text-lg font-bold text-orange-600">-</h3>
            <span class="text-slate-300">/</span>
            <h3 id="statAvgPerOp" class="text-lg font-bold text-purple-600">-</h3>
          </div>
        </div>
      </div>

      <div class="col-span-12 md:col-span-5 lg:col-span-4 card p-3">
        <h4 class="text-[11px] font-bold text-slate-700 mb-1 flex items-center gap-1">
          <i data-lucide="pie-chart" class="w-3 h-3"></i> 分類別シェア (点数)
        </h4>
        <div class="chart-container-small">
          <canvas id="categoryChart"></canvas>
        </div>
      </div>

      <div class="col-span-12 md:col-span-7 lg:col-span-5 card p-3">
        <h4 class="text-[11px] font-bold text-slate-700 mb-1 flex items-center gap-1">
          <i data-lucide="bar-chart-3" class="w-3 h-3"></i> 入院・外来内訳 (点数)
        </h4>
        <div class="chart-container-small">
          <canvas id="compareChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Dynamic Ranking Chart (Full Width) -->
    <div class="card p-4">
      <div class="flex justify-between items-end mb-3">
        <div>
          <h4 class="text-xs font-bold text-slate-700 flex items-center gap-1">
            <i data-lucide="trending-up" class="w-3 h-3 text-blue-600"></i>
            現在の並び替え順ランキング 上位20件
          </h4>
          <div class="mt-1 flex items-center gap-2">
            <span class="text-[10px] text-slate-400">対象項目:</span>
            <span id="currentSortLabel"
              class="text-[11px] bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full font-bold border border-blue-100">総点数</span>
          </div>
        </div>
        <p class="text-[10px] text-slate-400 italic">※表のヘッダーをクリックするとグラフの集計軸が切り替わります</p>
      </div>
      <div class="chart-container-full">
        <canvas id="rankingChart"></canvas>
      </div>
    </div>

    <!-- Table Row -->
    <div class="card overflow-hidden">
      <div class="px-4 py-2 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
        <div class="flex items-center gap-4">
          <h4 class="text-xs font-bold text-slate-700 flex items-center gap-1">
            <i data-lucide="list" class="w-3 h-3"></i> 明細一覧
          </h4>
          <div id="urlSettingInfo"
            class="hidden text-[10px] bg-amber-50 text-amber-700 px-2 py-0.5 rounded border border-amber-200">
            URL指定により一部除外中
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div id="searchHistoryContainer" class="hidden sm:flex flex-wrap gap-1 items-center"></div>
          <button id="exportCsv"
            class="text-[10px] bg-white border border-slate-200 px-2 py-1 rounded hover:bg-slate-50 flex items-center gap-1">
            <i data-lucide="download" class="w-3 h-3"></i> CSV
          </button>
        </div>
      </div>
      <div class="p-0">
        <table id="dataTable" class="display w-full text-xs">
          <thead>
            <tr></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    lucide.createIcons();

    const CSV_PATH = '2024m0018.csv';
    const STORAGE_KEY = 'medical_search_history';
    const MAX_HISTORY = 6;
    let table;
    let charts = {};
    const COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316', '#6366f1', '#14b8a6'];

    // 数値データの列インデックス
    const NUMERIC_COLS = [4, 6, 7, 8, 9, 10, 11];

    const CUSTOM_HEADERS = [
      "選択", "分類", "診療区分", "名称", "点数", "再掲",
      "総回数", "総点数", "入院回数", "入院点数", "外来回数", "外来点数"
    ];

    async function init() {
      try {
        const response = await fetch(CSV_PATH);
        const arrayBuffer = await response.arrayBuffer();
        const text = new TextDecoder('shift-jis').decode(arrayBuffer);
        Papa.parse(text, {
          skipEmptyLines: true,
          complete: (results) => processData(results.data)
        });
      } catch (err) {
        console.error(err);
        $('#dataStatus').text('Error').addClass('bg-red-100 text-red-700');
      }
    }

    function processData(rawData) {
      let startIdx = rawData.findIndex(row => row.some(c => c && c.includes('総計')));
      if (startIdx === -1) startIdx = 13;

      const params = new URLSearchParams(window.location.search);
      const removeList = (params.get('remove') || '').split(',').map(s => s.trim());
      let hasRemovedByUrl = false;

      const rows = rawData.slice(startIdx).filter(r => {
        if (!r[0] || r[0].trim() === '' || (r[2] || '').includes('小計')) return false;
        return r.length >= 10;
      }).map(r => {
        const name = (r[2] || '').trim();
        let isSelected = !removeList.includes(name);
        if (!isSelected) hasRemovedByUrl = true;
        return [isSelected, ...r];
      });

      if (hasRemovedByUrl) $('#urlSettingInfo').removeClass('hidden');

      setupTable(CUSTOM_HEADERS, rows);
      setupCharts();
      updateVisualsFromTable();
      renderHistoryTags();
      handleUrlParams();

      $('#dataStatus').text('Ready').removeClass('bg-yellow-100').addClass('bg-emerald-100 text-emerald-700');
    }

    function cleanNum(v) {
      if (!v || v === '-' || v === '*' || v === '') return 0;
      return parseFloat(v.toString().replace(/[^\d.-]/g, '')) || 0;
    }

    function setupTable(headers, data) {
      const headTr = $('#dataTable thead tr');
      headers.forEach((h, i) => {
        if (i === 0) {
          headTr.append(`<th class="text-center"><input type="checkbox" id="selectAll" class="row-checkbox" checked></th>`);
        } else {
          headTr.append(`<th>${h}</th>`);
        }
      });

      table = $('#dataTable').DataTable({
        data: data,
        columns: headers.map((h, i) => {
          if (i === 0) {
            return {
              data: i, className: 'text-center', orderable: false,
              render: (d) => `<input type="checkbox" class="row-checkbox item-check" ${d ? 'checked' : ''}>`
            };
          }
          return { data: i };
        }),
        language: { url: "https://cdn.datatables.net/plug-ins/1.13.7/i18n/ja.json" },
        pageLength: 50,
        scrollY: true,
        scrollCollapse: true,
        dom: 'rtip',
        columnDefs: [{
          targets: NUMERIC_COLS,
          type: 'num',
          render: (d, t) => (t === 'sort' || t === 'type') ? cleanNum(d) : d
        }],
        order: [[7, 'desc']] // 初期は総点数
      });

      // チェックボックス変更
      $('#dataTable tbody').on('change', '.item-check', function () {
        const tr = $(this).closest('tr');
        const rowData = table.row(tr).data();
        rowData[0] = this.checked;
        updateVisualsFromTable();
      });

      // 全選択
      $('#selectAll').on('change', function () {
        const isChecked = this.checked;
        table.rows({ search: 'applied' }).every(function () {
          const d = this.data(); d[0] = isChecked; this.data(d);
        });
        $('.item-check').prop('checked', isChecked);
        updateVisualsFromTable();
      });

      // 検索
      $('#globalSearch').on('keyup', function (e) {
        table.search(this.value).draw();
        if (e.key === 'Enter' && this.value.trim() !== '') saveSearchHistory(this.value.trim());
      });

      // ソート変更時にグラフを更新
      table.on('order.dt', () => {
        updateVisualsFromTable();
      });

      table.on('draw', () => updateVisualsFromTable());
    }

    function updateVisualsFromTable() {
      if (!table) return;
      // 「検索・フィルタが適用された状態」かつ「現在の表示順」の全データを取得
      const currentData = table.rows({ search: 'applied', order: 'applied' }).data().toArray();

      // チェックが入っているものだけで統計を出す
      const selectedData = currentData.filter(r => r[0] === true);
      updateAll(selectedData);
    }

    function handleUrlParams() {
      const query = new URLSearchParams(window.location.search).get('s');
      if (query) { $('#globalSearch').val(query); table.search(query).draw(); saveSearchHistory(query); }
    }

    function saveSearchHistory(query) {
      let history = Array.from(new Set([query, ...getHistory()])).slice(0, MAX_HISTORY);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
      renderHistoryTags();
    }

    function getHistory() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { return []; }
    }

    function renderHistoryTags() {
      const container = $('#searchHistoryContainer').empty();
      getHistory().forEach(text => {
        $(`<span class="search-tag text-[9px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border border-slate-200"></span>`)
          .text(text).on('click', () => { $('#globalSearch').val(text); table.search(text).draw(); }).appendTo(container);
      });
    }

    function updateAll(dataRows) {
      let totalPts = 0, inPts = 0, totalOps = 0;
      dataRows.forEach(r => {
        totalPts += cleanNum(r[7]); inPts += cleanNum(r[9]); totalOps += cleanNum(r[6]);
      });

      $('#statTotalRows').text(dataRows.length.toLocaleString());
      $('#statTotalPoints').text(totalPts.toLocaleString());
      $('#statInpatientRatio').text(`${totalPts > 0 ? ((inPts / totalPts) * 100).toFixed(1) : 0}%`);
      $('#statAvgPerOp').text((totalOps > 0 ? Math.round(totalPts / totalOps) : 0).toLocaleString());

      updateSummaryCharts(dataRows);
      updateRankingChart();
    }

    function setupCharts() {
      const opt = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };

      charts.category = new Chart($('#categoryChart'), {
        type: 'doughnut',
        data: { labels: [], datasets: [{ data: [], backgroundColor: COLORS, borderWidth: 1 }] },
        options: opt
      });

      charts.compare = new Chart($('#compareChart'), {
        type: 'bar',
        data: { labels: [], datasets: [] },
        options: { ...opt, indexAxis: 'y', scales: { x: { stacked: true, ticks: { font: { size: 9 } } }, y: { stacked: true, ticks: { font: { size: 9 } } } } }
      });

      charts.ranking = new Chart($('#rankingChart'), {
        type: 'bar',
        data: { labels: [], datasets: [{ label: '値', data: [], backgroundColor: '#3b82f6', borderRadius: 4 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(255, 255, 255, 0.9)',
              titleColor: '#1e293b',
              bodyColor: '#1e293b',
              borderColor: '#e2e8f0',
              borderWidth: 1,
              padding: 10,
              bodyFont: { size: 12, weight: 'bold' }
            }
          },
          scales: {
            x: { ticks: { font: { size: 9 }, maxRotation: 45, minRotation: 45 } },
            y: { beginAtZero: true, ticks: { font: { size: 10 }, callback: (v) => v.toLocaleString() } }
          }
        }
      });
    }

    function updateSummaryCharts(data) {
      // 分類別
      const cats = {};
      data.forEach(r => { cats[r[1]] = (cats[r[1]] || 0) + cleanNum(r[7]); });
      const topCats = Object.entries(cats).sort((a, b) => b[1] - a[1]).slice(0, 8);
      charts.category.data.labels = topCats.map(c => c[0]);
      charts.category.data.datasets[0].data = topCats.map(c => c[1]);
      charts.category.update();

      // 固定の上位比較
      const top6 = data.slice(0, 6);
      charts.compare.data.labels = top6.map(r => (r[3] || '').substring(0, 10));
      charts.compare.data.datasets = [
        { label: '入院', data: top6.map(r => cleanNum(r[9])), backgroundColor: '#3b82f6' },
        { label: '外来', data: top6.map(r => cleanNum(r[11])), backgroundColor: '#cbd5e1' }
      ];
      charts.compare.update();
    }

    function updateRankingChart() {
      if (!table || !charts.ranking) return;

      // 現在のソート列情報を取得
      const orderInfo = table.order()[0];
      const colIndex = orderInfo[0];
      const colLabel = CUSTOM_HEADERS[colIndex];

      // 数値列でない場合（名称など）はデフォルトで「総点数」
      const isNumeric = NUMERIC_COLS.includes(colIndex);
      const targetCol = isNumeric ? colIndex : 7;
      const displayLabel = isNumeric ? colLabel : "総点数 (デフォルト表示)";

      $('#currentSortLabel').text(displayLabel);

      // 「検索済み・ソート順そのまま」かつ「チェックがついているもの」の上位20件
      const rankedData = table.rows({ search: 'applied', order: 'applied' })
        .data().toArray()
        .filter(r => r[0] === true)
        .slice(0, 20);

      charts.ranking.data.labels = rankedData.map(r => (r[3] || r[2] || '').substring(0, 15));
      charts.ranking.data.datasets[0].data = rankedData.map(r => cleanNum(r[targetCol]));

      // 指標に合わせて色を変える（演出）
      let barColor = '#3b82f6'; // blue (点数系)
      if (colIndex === 6 || colIndex === 8 || colIndex === 10) barColor = '#10b981'; // emerald (回数系)
      if (colIndex === 4) barColor = '#8b5cf6'; // violet (固定点数)

      charts.ranking.data.datasets[0].backgroundColor = barColor;
      charts.ranking.update();
    }

    window.onload = init;
  </script>
</body>

</html>